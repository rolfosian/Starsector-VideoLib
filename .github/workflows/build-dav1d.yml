name: Build dav1d (x86_64) on macOS 15

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: macos-15

    steps:
    - name: Checkout dav1d source
      uses: actions/checkout@v4
      with:
        repository: videolan/dav1d
        ref: master

    - name: Install Build Dependencies
      run: |
        # Meson and Ninja are required for the build system
        # Nasm is required for x86_64 assembly optimizations (vital for dav1d performance)
        brew install meson ninja nasm

    - name: Create Meson Cross-File
      run: |
        cat <<EOF > x86_64-cross.txt
        [binaries]
        c = 'clang'
        cpp = 'clang++'
        objc = 'clang'
        objcpp = 'clang++'
        ar = 'ar'
        strip = 'strip'

        [host_machine]
        system = 'darwin'
        cpu_family = 'x86_64'
        cpu = 'x86_64'
        endian = 'little'

        [built-in options]
        c_args = ['-arch', 'x86_64']
        cpp_args = ['-arch', 'x86_64']
        c_link_args = ['-arch', 'x86_64']
        cpp_link_args = ['-arch', 'x86_64']
        EOF

    - name: Configure with Meson
      run: |
        meson setup build \
          --cross-file x86_64-cross.txt \
          --buildtype release \
          --default-library both

    - name: Build with Ninja
      run: ninja -C build

    - name: Verify Architecture
      run: |
        echo "Checking binary architectures..."
        # Check the static library
        lipo -info build/src/libdav1d.a
        # Check the dynamic library
        lipo -info build/src/libdav1d.*.dylib
        # Check the CLI tool
        lipo -info build/tools/dav1d