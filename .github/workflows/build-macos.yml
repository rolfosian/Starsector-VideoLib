name: Build FFmpeg static and JNI

on:
  push:
    branches:
      - main
    paths:
      - .github/workflows/build-macos.yml
  pull_request:
    paths:
      - .github/workflows/build-macos.yml
      - ffmpeg-jni/src/ffmpegjni.c

jobs:
  build-macos:
    name: macOS
    runs-on: macos-15
    env:
      DEPS_PREFIX: ${{ github.workspace }}/deps-static
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        id: setup-java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          architecture: x64

      - name: Install build dependencies

        run: |
          brew update
          brew install nasm yasm meson ninja automake autoconf libtool pkg-config

      - name: Build libogg (static x86_64)
        run: |
          git clone --depth=1 https://github.com/xiph/ogg.git
          cd ogg

          ./autogen.sh

          export CC="clang"
          export CXX="clang++"
          export CFLAGS="-arch x86_64 -O3"
          export LDFLAGS="-arch x86_64"
          
          ./configure \
            --prefix="$DEPS_PREFIX" \
            --disable-shared \
            --enable-static \
            --host=x86_64-apple-darwin
            
          make -j$(sysctl -n hw.ncpu)
          make install


      - name: Build libvorbis (static x86_64)
        run: |
          git clone --depth=1 https://github.com/xiph/vorbis.git
          cd vorbis
          
          ./autogen.sh
          
          sed -i '' 's/-force_cpusubtype_ALL//g' configure

          export CC="clang"
          export CXX="clang++"
          export CFLAGS="-arch x86_64 -O3"
          export LDFLAGS="-arch x86_64"
          export PKG_CONFIG_PATH="$DEPS_PREFIX/lib/pkgconfig"

          ./configure \
            --prefix="$DEPS_PREFIX" \
            --disable-shared \
            --enable-static \
            --host=x86_64-apple-darwin \
            --with-ogg-libraries="$DEPS_PREFIX/lib" \
            --with-ogg-includes="$DEPS_PREFIX/include"
            
          make -j$(sysctl -n hw.ncpu)
          make install

      - name: Build libopus (static x86_64)
        run: |
          git clone --depth=1 https://github.com/xiph/opus.git
          cd opus
          
          ./autogen.sh
          
          export CC="clang"
          export CXX="clang++"
          export CFLAGS="-arch x86_64 -O3"
          export LDFLAGS="-arch x86_64"
          
          ./configure \
            --prefix="$DEPS_PREFIX" \
            --disable-shared \
            --enable-static \
            --disable-extra-programs \
            --disable-doc \
            --host=x86_64-apple-darwin
            
          make -j$(sysctl -n hw.ncpu)
          make install

      - name: Build libdav1d (static x86_64)
        run: |
          git clone --depth=1 https://code.videolan.org/videolan/dav1d.git dav1d-src
          cd dav1d-src
          
          cat <<EOF > x86_64-cross.txt
          [binaries]
          c = 'clang'
          cpp = 'clang++'
          objc = 'clang'
          objcpp = 'clang++'
          ar = 'ar'
          strip = 'strip'

          [host_machine]
          system = 'darwin'
          cpu_family = 'x86_64'
          cpu = 'x86_64'
          endian = 'little'

          [built-in options]
          c_args = ['-arch', 'x86_64']
          cpp_args = ['-arch', 'x86_64']
          c_link_args = ['-arch', 'x86_64']
          cpp_link_args = ['-arch', 'x86_64']
          EOF

          meson setup build \
            --cross-file x86_64-cross.txt \
            --buildtype release \
            --default-library=static \
            --prefix="$DEPS_PREFIX"
            
          ninja -C build
          ninja -C build install

      - name: Verify Architectures (Strict x86_64)
        run: |
          # Define the libraries to check
          libs=(
            "$DEPS_PREFIX/lib/libogg.a"
            "$DEPS_PREFIX/lib/libvorbis.a"
            "$DEPS_PREFIX/lib/libopus.a"
            "$DEPS_PREFIX/lib/libdav1d.a"
          )

          failed=0

          for lib in "${libs[@]}"; do
            # 1. Check if file exists
            if [ ! -f "$lib" ]; then
              echo "::error::File not found: $lib"
              failed=1
              continue
            fi

            # 2. Check architecture
            # 'lipo -archs' returns just the arch string (e.g., "x86_64" or "arm64")
            arch=$(lipo -archs "$lib")
            
            echo "Checking $lib... Found: '$arch'"

            if [ "$arch" != "x86_64" ]; then
              echo "::error::Architecture mismatch for $lib! Expected 'x86_64', but found '$arch'."
              failed=1
            fi
          done

          # 3. Fail the job if any library was wrong
          if [ "$failed" -eq 1 ]; then
            echo "One or more libraries were not compiled for x86_64."
            exit 1
          else
            echo "Success: All libraries are valid x86_64 binaries."
          fi

      - name: Fetch FFmpeg source
        run: git clone --depth=1 https://github.com/FFmpeg/FFmpeg.git ffmpeg-src

      - name: Build FFmpeg (static x86_64)
        working-directory: ffmpeg-src
        run: |
          export PKG_CONFIG_PATH="$DEPS_PREFIX/lib/pkgconfig:$PKG_CONFIG_PATH"
          
          ./configure \
            --prefix="${GITHUB_WORKSPACE}/ffmpeg-static/mac" \
            --pkg-config-flags="--static" \
            --disable-everything \
            --disable-doc \
            --disable-programs \
            --disable-debug \
            --disable-ffplay \
            --disable-ffprobe \
            --enable-gpl \
            --enable-static \
            --disable-shared \
            --enable-cross-compile \
            --target-os=darwin \
            --arch=x86_64 \
            --enable-libvorbis \
            --enable-libopus \
            --enable-libdav1d \
            --enable-decoder=h264,hevc,vp8,vp9,mjpeg,png,webp,gif,opus,vorbis,libdav1d,aac \
            --enable-parser=h264,hevc,vp8,vp9,mjpeg,png,webp,gif,aac,mpegaudio \
            --enable-demuxer=matroska,mov,image2,gif \
            --enable-protocol=file \
            --enable-pic \
            --cc="clang" \
            --cxx="clang++" \
            --extra-cflags="-fPIC -arch x86_64 -I$DEPS_PREFIX/include" \
            --extra-ldflags="-arch x86_64 -L$DEPS_PREFIX/lib"
          
          make -j"$(sysctl -n hw.ncpu)"
          make install

      - name: Verify FFmpeg Architecture
        run: |
          ls -R "${GITHUB_WORKSPACE}/ffmpeg-static/mac/lib"
          # Verify the binary is actually x86_64
          lipo -info "${GITHUB_WORKSPACE}/ffmpeg-static/mac/lib/libavcodec.a"

      - name: Build JNI bridge (ffmpegjni.dylib)
        env:
          JAVA_HOME: ${{ env.JAVA_HOME }}
          SRC: ffmpeg-jni/src/ffmpegjni.c
          OUT_DIR: ffmpeg-jni/bin/mac
          PREFIX: ${{ github.workspace }}/ffmpeg-static/mac
        run: |
          mkdir -p "$OUT_DIR"

          CFLAGS="-O3 -DNDEBUG -fPIC -arch x86_64 -fvisibility=hidden"
          
          INCLUDES=(
            "-I$PREFIX/include"
            "-I$DEPS_PREFIX/include"
            "-I$JAVA_HOME/include"
            "-I$JAVA_HOME/include/darwin"
          )

          LIB_PATHS=(
            "-L$PREFIX/lib"
            "-L$DEPS_PREFIX/lib"
          )

          FFMPEG_LIBS=(
            "-lavformat"
            "-lavcodec"
            "-lswscale"
            "-lswresample"
            "-lavutil"
          )

          STATIC_DEPS=(
            "-ldav1d"
            "-lvorbis"
            "-lvorbisenc"
            "-lopus"
            "-logg"
          )

          SYS_LIBS=(
            "-lm"
            "-lz"
            "-lbz2"
            "-lpthread"
            "-liconv"
          )

          FRAMEWORKS=(
            "-framework" "CoreFoundation"
            "-framework" "CoreVideo"
            "-framework" "VideoToolbox"
            "-framework" "CoreMedia"
            "-framework" "AudioToolbox"
            "-framework" "Security"
          )

          echo "Compiling and Linking JNI dylib..."
          
          clang $CFLAGS \
            -dynamiclib \
            -Wl,-undefined,error \
            "${INCLUDES[@]}" \
            -o "$OUT_DIR/ffmpegjni.dylib" \
            "$SRC" \
            "${LIB_PATHS[@]}" \
            "${FFMPEG_LIBS[@]}" \
            "${STATIC_DEPS[@]}" \
            "${FRAMEWORKS[@]}" \
            "${SYS_LIBS[@]}"

          echo "Verifying Dependencies (otool):"
          otool -L "$OUT_DIR/ffmpegjni.dylib"

      - name: Upload artifacts (macOS)
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: |
            ffmpeg-static/mac
            deps-static
            ffmpeg-jni/bin/mac/ffmpegjni.dylib