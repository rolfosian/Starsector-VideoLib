name: Build FFmpeg static and JNI

on:
  push:
    branches:
      - main
    paths:
      - .github/workflows/build-macos.yml
  pull_request:
    paths:
      - .github/workflows/build-macos.yml
      - ffmpeg-jni/src/ffmpegjni.c

jobs:
  build-macos:
    name: macOS
    runs-on: macos-15
    env:
      DEPS_PREFIX: ${{ github.workspace }}/deps-static
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        id: setup-java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          architecture: x64

      - name: Install build dependencies

        run: |
          brew update
          brew install nasm yasm meson ninja automake autoconf libtool pkg-config

      - name: Build libogg (static x86_64)
        run: |
          git clone --depth=1 https://github.com/xiph/ogg.git
          cd ogg
          ./autogen.sh
          # --host triggers cross-compilation mode
          ./configure \
            --prefix="$DEPS_PREFIX" \
            --disable-shared \
            --enable-static \
            --host=x86_64-apple-darwin \
            CFLAGS="-arch x86_64" \
            LDFLAGS="-arch x86_64"
          make -j$(sysctl -n hw.ncpu)
          make install

      - name: Build libvorbis (static x86_64)
        run: |
          git clone --depth=1 https://github.com/xiph/vorbis.git
          cd vorbis
          ./autogen.sh
          # Must point to the Ogg we just built
          export PKG_CONFIG_PATH="$DEPS_PREFIX/lib/pkgconfig"
          ./configure \
            --prefix="$DEPS_PREFIX" \
            --disable-shared \
            --enable-static \
            --host=x86_64-apple-darwin \
            CFLAGS="-arch x86_64" \
            LDFLAGS="-arch x86_64"
          make -j$(sysctl -n hw.ncpu)
          make install

      - name: Build libopus (static x86_64)
        run: |
          git clone --depth=1 https://github.com/xiph/opus.git
          cd opus
          ./autogen.sh
          ./configure \
            --prefix="$DEPS_PREFIX" \
            --disable-shared \
            --enable-static \
            --disable-extra-programs \
            --host=x86_64-apple-darwin \
            CFLAGS="-arch x86_64" \
            LDFLAGS="-arch x86_64"
          make -j$(sysctl -n hw.ncpu)
          make install

      - name: Build libdav1d (static x86_64)
        run: |
          git clone --depth=1 https://code.videolan.org/videolan/dav1d.git dav1d-src
          cd dav1d-src
          mkdir build && cd build
          
          export CFLAGS="-arch x86_64" 
          export LDFLAGS="-arch x86_64"
          
          meson setup \
            --default-library=static \
            --buildtype=release \
            --prefix="$DEPS_PREFIX" \
            ..
          ninja
          ninja install

          - name: See structure of deps prefix
          run: |
            echo "DEPS_PREFIX=$DEPS_PREFIX"
            find "$DEPS_PREFIX" -print
      # - name: Fetch FFmpeg source
      #   run: git clone --depth=1 https://github.com/FFmpeg/FFmpeg.git ffmpeg-src

      # - name: Build FFmpeg (static x86_64)
      #   working-directory: ffmpeg-src
      #   run: |
      #     export PKG_CONFIG_PATH="$DEPS_PREFIX/lib/pkgconfig:$PKG_CONFIG_PATH"
          
      #     ./configure \
      #       --disable-everything \
      #       --disable-doc \
      #       --disable-programs \
      #       --disable-debug \
      #       --disable-ffplay \
      #       --disable-ffprobe \
      #       --enable-gpl \
      #       --enable-static \
      #       --disable-shared \
      #       --prefix="${GITHUB_WORKSPACE}/ffmpeg-static/mac" \
      #       --enable-cross-compile \
      #       --target-os=darwin \
      #       --arch=x86_64 \
      #       --enable-libvorbis \
      #       --enable-libopus \
      #       --enable-libdav1d \
      #       --enable-decoder=h264,hevc,vp8,vp9,mjpeg,png,webp,gif,opus,vorbis,libdav1d \
      #       --enable-parser=h264,hevc,vp8,vp9,mjpeg,png,webp,gif,aac,mpegaudio \
      #       --enable-demuxer=matroska,mov,image2,gif \
      #       --enable-pic \
      #       --cc="clang" \
      #       --cxx="clang++" \
      #       --extra-cflags="-fPIC -arch x86_64 -I$DEPS_PREFIX/include" \
      #       --extra-ldflags="-arch x86_64 -L$DEPS_PREFIX/lib"
          
      #     make -j"$(sysctl -n hw.ncpu)"
      #     make install

      # - name: Debug FFmpeg install
      #   run: |
      #     ls -R "${GITHUB_WORKSPACE}/ffmpeg-static/mac/lib"
      #     # Verify the binary is actually x86_64
      #     lipo -info "${GITHUB_WORKSPACE}/ffmpeg-static/mac/lib/libavcodec.a"

      # - name: Build JNI bridge (ffmpegjni.dylib)
      #   env:
      #     JAVA_HOME: ${{ env.JAVA_HOME }}
      #     SRC: ffmpeg-jni/src/ffmpegjni.c
      #     OUT_DIR: ffmpeg-jni/bin/mac
      #     PREFIX: ${{ github.workspace }}/ffmpeg-static/mac
      #     DAV1D_PREFIX: ${{ github.workspace }}/dav1d-static
      #   run: |
      #     mkdir -p "$OUT_DIR"
      #     clang -O2 -DNDEBUG -fPIC \
      #       -I"$PREFIX/include" \
      #       -I"$JAVA_HOME/include" \
      #       -I"$JAVA_HOME/include/darwin" \
      #       -I"$DAV1D_PREFIX/include" \
      #       -o "$OUT_DIR/ffmpegjni.dylib" \
      #       -dynamiclib \
      #       -Wl,-undefined,error \
      #       -arch x86_64 \
      #       -mmacosx-version-min=10.15 \
      #       "$SRC" \
      #       -L"$PREFIX/lib" \
      #       -L"$DAV1D_PREFIX/lib" \
      #       "$PREFIX/lib/libswscale.a" \
      #       "$PREFIX/lib/libavformat.a" \
      #       "$PREFIX/lib/libavcodec.a" \
      #       "$PREFIX/lib/libavutil.a" \
      #       "$PREFIX/lib/libswresample.a" \
      #       "$DAV1D_PREFIX/lib/libdav1d.a" \
      #       -lpthread \
      #       -lm \
      #       -lz \
      #       -lbz2 \
      #       -liconv \
      #       -framework CoreVideo \
      #       -framework VideoToolbox \
      #       -framework CoreMedia \
      #       -framework CoreFoundation
      # - name: Upload artifacts (macOS)
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: macos-build
      #     path: |
      #       ffmpeg-static/mac
      #       dav1d-static
      #       ffmpeg-jni/bin/mac/ffmpegjni.dylib